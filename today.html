<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menu scuola ‚Äì C10</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;line-height:1.35}
    .card{max-width:720px;margin:0 auto;border:1px solid #e6e6e6;border-radius:14px;padding:14px 14px 10px}
    h1{font-size:18px;margin:0 0 6px}
    .sub{color:#555;margin:0 0 10px}
    ul{margin:10px 0 14px;padding-left:18px}
    li{margin:4px 0}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{display:inline-block;padding:10px 12px;border:1px solid #ccc;border-radius:12px;text-decoration:none;color:inherit}
  </style>
</head>
<body>
  <div class="card">
    <h1>üçΩÔ∏è Menu scuola ‚Äì C10</h1>
    <p class="sub" id="date">üìÖ ‚Ä¶</p>

    <ul id="list"></ul>

    <div class="btnrow">
      <a class="btn" id="openSrc" href="#" target="_blank" rel="noopener">Apri sito ufficiale</a>
      <a class="btn" href="./">Torna alla home</a>
    </div>
  </div>

<script>
  const WORKER_URL = "https://menu-push-c10.egon-angeli-info.workers.dev";

  async function loadMenu() {
    const params = new URLSearchParams(location.search);

    let date = params.get("date");
    let dishes = null;
    let source = params.get("source") || "https://menuscuole.risto3cloud.it/menu";
    const dishesRaw = params.get("dishes");

    if (dishesRaw) {
      // Caso: arrivo da notifica (con parametri)
      try {
        dishes = JSON.parse(dishesRaw);
      } catch (e) {
        console.error("Errore parse dishes dalla query:", e);
        dishes = [];
      }
    } else {
      // Caso: apertura manuale ‚Üí chiedi al Worker il menu di oggi
      try {
        const res = await fetch(WORKER_URL + "/menu-today?sourceId=c10");
        if (res.ok) {
          const json = await res.json();
          if (json.ok && json.menu) {
            date = json.menu.date || date;
            dishes = json.menu.dishes || [];
            source = json.menu.source || source;
          }
        } else {
          console.warn("menu-today non disponibile:", res.status);
        }
      } catch (e) {
        console.error("Errore nel recupero menu-today:", e);
      }
    }

    if (!date) date = "Oggi";
    if (!Array.isArray(dishes)) dishes = [];

    // Aggiorna data
    const dateEl = document.getElementById("date");
    if (dateEl) {
      dateEl.textContent = "üìÖ " + date;
    }

    // Aggiorna lista piatti
    const ul = document.getElementById("list");
    if (ul) {
      ul.innerHTML = "";
      if (!dishes.length) {
        const li = document.createElement("li");
        li.textContent = "Nessun piatto trovato";
        ul.appendChild(li);
      } else {
        dishes.forEach((d) => {
          const li = document.createElement("li");
          li.textContent = "‚Ä¢ " + String(d);
          ul.appendChild(li);
        });
      }
    }

    // Aggiorna link "Apri sito ufficiale"
    const open = document.getElementById("openSrc");
    if (open) {
      open.href = source;
    }
  }

  loadMenu();
</script>


</body>
</html>
